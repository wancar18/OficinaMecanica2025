export const MIGRATIONS_SQL = "\nCREATE TABLE IF NOT EXISTS users (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  username TEXT UNIQUE NOT NULL,\n  display_name TEXT,\n  role TEXT NOT NULL CHECK(role IN ('admin','atendente','mecanico')) DEFAULT 'admin',\n  password_hash TEXT NOT NULL,\n  must_change_password INTEGER DEFAULT 1,\n  active INTEGER DEFAULT 1,\n  created_at TEXT DEFAULT (datetime('now'))\n);\nCREATE TABLE IF NOT EXISTS customers (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  name TEXT NOT NULL,\n  alias TEXT,\n  cpf_cnpj TEXT,\n  ie_rg TEXT,\n  email TEXT,\n  phone TEXT,\n  phone_alt TEXT,\n  address TEXT,\n  city TEXT,\n  state TEXT,\n  zip TEXT,\n  notes TEXT,\n  created_at TEXT DEFAULT (datetime('now'))\n);\nCREATE TABLE IF NOT EXISTS vehicles (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  customer_id INTEGER NOT NULL REFERENCES customers(id) ON DELETE RESTRICT,\n  plate TEXT NOT NULL UNIQUE,\n  brand TEXT,\n  model TEXT,\n  year INTEGER,\n  color TEXT,\n  vin TEXT,\n  engine TEXT,\n  mileage INTEGER,\n  fuel TEXT,\n  notes TEXT,\n  created_at TEXT DEFAULT (datetime('now'))\n);\nCREATE TABLE IF NOT EXISTS service_catalog (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  name TEXT NOT NULL,\n  description TEXT,\n  default_price REAL NOT NULL DEFAULT 0,\n  default_hours REAL NOT NULL DEFAULT 0,\n  active INTEGER DEFAULT 1\n);\nCREATE TABLE IF NOT EXISTS orders (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  code TEXT UNIQUE,\n  customer_id INTEGER NOT NULL REFERENCES customers(id),\n  vehicle_id INTEGER NOT NULL REFERENCES vehicles(id),\n  status TEXT NOT NULL CHECK(status IN ('aberta','aprovada','em_execucao','concluida','entregue','cancelada')) DEFAULT 'aberta',\n  payment_status TEXT NOT NULL CHECK(payment_status IN ('nao_pago','parcial','pago')) DEFAULT 'nao_pago',\n  mileage_in INTEGER,\n  mileage_out INTEGER,\n  discount REAL DEFAULT 0,\n  surcharge REAL DEFAULT 0,\n  total_services REAL DEFAULT 0,\n  total_parts REAL DEFAULT 0,\n  total REAL DEFAULT 0,\n  notes TEXT,\n  opened_at TEXT DEFAULT (datetime('now')),\n  closed_at TEXT,\n  created_by INTEGER REFERENCES users(id)\n);\nCREATE TABLE IF NOT EXISTS order_items (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE CASCADE,\n  item_type TEXT NOT NULL CHECK(item_type IN ('service','part')) DEFAULT 'service',\n  catalog_id INTEGER,\n  description TEXT NOT NULL,\n  qty REAL NOT NULL DEFAULT 1,\n  unit_price REAL NOT NULL DEFAULT 0,\n  discount REAL NOT NULL DEFAULT 0,\n  total REAL NOT NULL DEFAULT 0,\n  technician_id INTEGER REFERENCES users(id)\n);\nCREATE TABLE IF NOT EXISTS payments (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  order_id INTEGER REFERENCES orders(id) ON DELETE SET NULL,\n  date TEXT NOT NULL DEFAULT (date('now')),\n  method TEXT NOT NULL,\n  amount REAL NOT NULL,\n  status TEXT NOT NULL CHECK(status IN ('recebido','pendente','estornado')) DEFAULT 'recebido',\n  notes TEXT\n);\nCREATE TABLE IF NOT EXISTS expenses (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  date TEXT NOT NULL DEFAULT (date('now')),\n  category TEXT NOT NULL,\n  method TEXT NOT NULL,\n  vendor TEXT,\n  description TEXT,\n  amount REAL NOT NULL,\n  notes TEXT\n);\nCREATE TABLE IF NOT EXISTS audit_log (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  ts TEXT DEFAULT (datetime('now')),\n  user_id INTEGER REFERENCES users(id),\n  entity TEXT,\n  entity_id INTEGER,\n  action TEXT,\n  details TEXT\n);\nCREATE TABLE IF NOT EXISTS settings ( key TEXT PRIMARY KEY, value TEXT );\nCREATE TABLE IF NOT EXISTS attachments (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,\n  type TEXT NOT NULL,\n  data TEXT NOT NULL,\n  created_at TEXT DEFAULT (datetime('now'))\n);\nCREATE VIEW IF NOT EXISTS vw_order_totals AS\nSELECT o.id, COALESCE(SUM(oi.total),0) AS items_total\nFROM orders o LEFT JOIN order_items oi ON oi.order_id = o.id\nGROUP BY o.id;\nCREATE VIEW IF NOT EXISTS vw_payments_received AS\nSELECT o.id AS order_id,\n       COALESCE(SUM(CASE WHEN p.status='recebido' THEN p.amount ELSE 0 END),0) AS received_total\nFROM orders o LEFT JOIN payments p ON p.order_id = o.id\nGROUP BY o.id;\nCREATE TRIGGER IF NOT EXISTS trg_order_items_ai AFTER INSERT ON order_items\nBEGIN\n  UPDATE order_items SET total = (NEW.qty * NEW.unit_price) - NEW.discount WHERE id = NEW.id;\n  UPDATE orders SET\n    total_services = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = NEW.order_id AND item_type='service'),\n    total_parts = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = NEW.order_id AND item_type='part'),\n    total = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = NEW.order_id) - discount + surcharge\n  WHERE id = NEW.order_id;\nEND;\nCREATE TRIGGER IF NOT EXISTS trg_order_items_au AFTER UPDATE ON order_items\nBEGIN\n  UPDATE order_items SET total = (NEW.qty * NEW.unit_price) - NEW.discount WHERE id = NEW.id;\n  UPDATE orders SET\n    total_services = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = NEW.order_id AND item_type='service'),\n    total_parts = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = NEW.order_id AND item_type='part'),\n    total = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = NEW.order_id) - discount + surcharge\n  WHERE id = NEW.order_id;\nEND;\nCREATE TRIGGER IF NOT EXISTS trg_order_items_ad AFTER DELETE ON order_items\nBEGIN\n  UPDATE orders SET\n    total_services = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = OLD.order_id AND item_type='service'),\n    total_parts = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = OLD.order_id AND item_type='part'),\n    total = (SELECT COALESCE(SUM(total),0) FROM order_items WHERE order_id = OLD.order_id) - discount + surcharge\n  WHERE id = OLD.order_id;\nEND;\nCREATE TRIGGER IF NOT EXISTS trg_payments_ai AFTER INSERT ON payments\nBEGIN\n  UPDATE orders SET payment_status = (\n    CASE\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = NEW.order_id) >= total THEN 'pago'\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = NEW.order_id) > 0 THEN 'parcial'\n      ELSE 'nao_pago'\n    END\n  ) WHERE id = NEW.order_id;\nEND;\nCREATE TRIGGER IF NOT EXISTS trg_payments_au AFTER UPDATE ON payments\nBEGIN\n  UPDATE orders SET payment_status = (\n    CASE\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = NEW.order_id) >= total THEN 'pago'\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = NEW.order_id) > 0 THEN 'parcial'\n      ELSE 'nao_pago'\n    END\n  ) WHERE id = NEW.order_id;\n  UPDATE orders SET payment_status = (\n    CASE\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = OLD.order_id) >= total THEN 'pago'\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = OLD.order_id) > 0 THEN 'parcial'\n      ELSE 'nao_pago'\n    END\n  ) WHERE id = OLD.order_id;\nEND;\nCREATE TRIGGER IF NOT EXISTS trg_payments_ad AFTER DELETE ON payments\nBEGIN\n  UPDATE orders SET payment_status = (\n    CASE\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = OLD.order_id) >= total THEN 'pago'\n      WHEN (SELECT COALESCE(SUM(CASE WHEN status='recebido' THEN amount ELSE 0 END),0) FROM payments WHERE order_id = OLD.order_id) > 0 THEN 'parcial'\n      ELSE 'nao_pago'\n    END\n  ) WHERE id = OLD.order_id;\nEND;\nCREATE TABLE IF NOT EXISTS _meta ( key TEXT PRIMARY KEY, value TEXT );\n"
